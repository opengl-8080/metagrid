# ファイル取り込み
## 要件
- コミット単位
    - 基本は１件ずつコミット
    - 全件コミットに切り替えられるようにしたくなるかも
        - トランザクション制御を簡単に切り替えられるようにする
        - トランザクション制御はプラガブルにする
- アップロードしたファイルの扱い
    - アップロードされたファイル自体は残さない
- エラー制御
    - エラーの通知
        - エラーのあった行の末尾にメッセージを載せてダウンロードさせる
    - エラーがあったときに処理を続行するか
        - フォーマットエラー、業務エラーの行はスキップして続行
        - システムエラーは中断
            - その時点までに処理した中でエラーとなったものだけ返す
- 非同期処理
    - ファイルの取り込み処理は非同期で行う
        - 一度に同時並行できる限界数を設定ファイルで指定
    - クライアントには、取り込み処理を問い合わせられる識別子（問い合わせID）を返す
    - 問い合わせ
        - 現在の状態
            - 状態
                - 待機
                - 処理中
                - 終了
                    - エラー終了
                    - 正常終了
                    - 中断
            - 件数
                - 全体
                - 処理済み
            - 時間
                - １件あたりの平均処理時間
                - 終了予定時刻
        - エラーの確認
            - エラー件数
            - エラーファイルのダウンロード
    - 中断
        - 問い合わせIDを指定して処理を中断できる
        - 一度中断したら、続行は不可
    - 終了の通知（発展）
        - Websocket か Server Sent Event で通知できたらいいやん
            - Websocket なら Servlet 3.1 で使えるのでアプリケーション・サーバーに依らず実現可能
        - 問い合わせIDで接続
        - 処理が終了したら、サーバーからプッシュ通知がくる

## シナリオ
### ファイルアップロード
#### 正常
1. ユーザーはファイルをアップロードする
1. システムは問い合わせIDを発行してユーザーに返却する
1. システムはアップロードされたファイルの取り込み処理を開始する

#### エラー
なし

### 問い合わせ
#### 正常
1. ユーザーは問い合わせIDを使ってアップロードの状態を問い合わせる
1. システムは問い合わせIDを元にアップロード処理の状態を取得し、ユーザーに返す

#### エラー
1. 問い合わせIDに紐づくアップロードが見つからない場合
    1. システムは問い合わせIDに紐づくアップロードが存在しないことを通知する

## 設計
### フロー
#### アップロード
1. ファイルをアップロードする
1. ファイルの内容を DB に格納する
    - 問い合わせID
        - 普通の連番
    - ファイル名
    - ファイル内容（CLOB でまるごと格納）
1. ファイルの取り込み処理を別スレッドにディスパッチする
1. 問い合わせIDをクライアントに返す

#### ファイルの取り込み処理
1. DB から内容を取得する（ストリームで順次取得にすること）
1. エラーがあったら情報を DB に書き込む
    - エラー行の生データ
    - エラーメッセージ
1. １件ずつコミットする



